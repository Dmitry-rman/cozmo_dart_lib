# Audio Takeover Pattern - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –∞—É–¥–∏–æ –∏ —ç–∫—Ä–∞–Ω–∞

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ –∞—É–¥–∏–æ –∏ AnimationController –≤–æ–∑–Ω–∏–∫–∞—é—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã:

1. **AnimController** —à–ª–µ—Ç `OutputSilence (0x8f)` –∫–∞–∂–¥—ã–µ 33–º—Å –¥–ª—è keep-alive
2. **Audio** —à–ª–µ—Ç `OutputAudio (0x8e)` –ø–∞–∫–µ—Ç—ã –∫–∞–∂–¥—ã–µ 33.7–º—Å –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
3. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç:** –î–≤–∞ —Ç–∏–ø–∞ –ø–∞–∫–µ—Ç–æ–≤ –≤ –æ–¥–∏–Ω –∫–∞–Ω–∞–ª ‚Üí –ø—Ä–µ—Ä—ã–≤–∏—Å—Ç–æ–µ –∞—É–¥–∏–æ

## üí° –†–µ—à–µ–Ω–∏–µ –æ—Ç pycozmo

PyCozmo –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω **"Audio Takeover"**:

1. AnimController —Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞ (30 FPS)
2. –û–±—ã—á–Ω–æ —à–ª–µ—Ç OutputSilence (—á—Ç–æ–±—ã —Ä–æ–±–æ—Ç –∂–∏–ª)
3. –ö–æ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∞—É–¥–∏–æ ‚Üí **AnimController –∑–∞–º–æ–ª–∫–∞–µ—Ç**
4. –ê—É–¥–∏–æ-–º–æ–¥—É–ª—å –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å
5. –ö–æ–≥–¥–∞ –∞—É–¥–∏–æ –∫–æ–Ω—á–∞–µ—Ç—Å—è ‚Üí **AnimController —Å–Ω–æ–≤–∞ –≥–æ–≤–æ—Ä–∏—Ç**

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### AnimationController

```dart
class CozmoAnimController {
  final CozmoClient _client;
  bool _isAudioBusy = false;  // –§–ª–∞–≥ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –∞—É–¥–∏–æ

  void _tick() {
    // 1. –ê–£–î–ò–û / –¢–ò–®–ò–ù–ê
    // –ï—Å–ª–∏ –∞—É–¥–∏–æ –∑–∞–Ω—è—Ç–æ - –ú–´ –ú–û–õ–ß–ò–ú
    if (!_isAudioBusy) {
      _client.sendCommand(CozmoCmd.outputSilence, []);
    }

    // 2. –≠–ö–†–ê–ù (–î–ê–ñ–ï –í–û –í–†–ï–ú–Ø –ê–£–î–ò–û!)
    if (_tickCounter % 30 == 0 && _currentImagePayload != null) {
      _client.sendCommand(CozmoCmd.displayImage, _currentImagePayload!);
    }

    _tickCounter++;
  }

  // –ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –∞—É–¥–∏–æ-–º–æ–¥—É–ª—è
  void setAudioBusy(bool busy) {
    _isAudioBusy = busy;
  }
}
```

### Audio Module

```dart
class CozmoAudio {
  final CozmoClient _client;
  final CozmoAnimController _animController;

  Future<void> _streamPackets(List<List<int>> packets) async {
    // 1. –ó–ê–•–í–ê–¢–´–í–ê–ï–ú –ö–û–ù–¢–†–û–õ–¨
    _animController.setAudioBusy(true);  // –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∑–∞–º–æ–ª–∫–∞–µ—Ç

    try {
      // 2. –ë–´–°–¢–†–ê–Ø –û–¢–ü–†–ê–í–ö–ê (–±–µ–∑ —Ç–∞–π–º–∏–Ω–≥–∞!)
      for (int i = 0; i < packets.length; i++) {
        // –¢–æ–ª—å–∫–æ backpressure —Ç–æ—Ä–º–æ–∑–∏—Ç –Ω–∞—Å
        while (_client.outboundQueueLength > 100) {
          await Future.delayed(const Duration(milliseconds: 1));
        }
        _client.sendRawPacket(packets[i]);
      }

      // 3. –ñ–¥–µ–º –ø–æ–∫–∞ –æ—á–µ—Ä–µ–¥—å –æ–ø—É—Å—Ç–µ–µ—Ç
      while (_client.outboundQueueLength > 0) {
        await Future.delayed(const Duration(milliseconds: 50));
      }
    } finally {
      // 4. –í–û–ó–í–†–ê–©–ê–ï–ú –ö–û–ù–¢–†–û–õ–¨
      _animController.setAudioBusy(false);  // –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Å–Ω–æ–≤–∞ —à–ª–µ—Ç silence
    }
  }
}
```

## üîë –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### 1. Fast Sending (–ë—ã—Å—Ç—Ä–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞)

**‚ùå –ü–õ–û–•–û** - —Ç–æ—á–Ω—ã–π —Ç–∞–π–º–∏–Ω–≥ —Å–æ–∑–¥–∞–µ—Ç –±—É—Ç—ã–ª–æ—á–Ω–æ–µ –≥–æ—Ä–ª—ã—à–∫–æ:
```dart
final targetTime = startTime + ((i + 1) * packetDurationUs);
await Future.delayed(Duration(microseconds: diff));
```

**‚úÖ –•–û–†–û–®–û** - —à–ª–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±—ã—Å—Ç—Ä–æ:
```dart
_client.sendRawPacket(packets[i]);  // –°—Ä–∞–∑—É!
```

### 2. No App-Level Timing (–¢–∞–π–º–∏–Ω–≥ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ç–∏)

**PyCozmo approach:**
```python
class SendThread(Thread):
    COLLECT_INTERVAL = 1/30 / 3  # ~11 –º—Å

    def send(self, data):
        self.queue.put(data)  # –ü—Ä–æ—Å—Ç–æ –≤ –æ—á–µ—Ä–µ–¥—å!
```

**–ü–∞–∫–µ—Ç—ã –∫–ª–∞–¥—É—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å –ë–ï–ó –∑–∞–¥–µ—Ä–∂–µ–∫**, —Å–µ—Ç–µ–≤–æ–π —Å–ª–æ–π —Å–∞–º –±—É—Ñ–µ—Ä–∏–∑–∏—Ä—É–µ—Ç.

### 3. Audio Takeover (–ó–∞—Ö–≤–∞—Ç –∞—É–¥–∏–æ)

```
–û–±—ã—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
AnimController: OutputSilence (33ms) ‚Üí OutputSilence (33ms) ‚Üí ...
–≠–∫—Ä–∞–Ω: DisplayImage (1—Å–µ–∫)

–í–æ –≤—Ä–µ–º—è –∞—É–¥–∏–æ:
Audio: OutputAudio ‚Üí OutputAudio ‚Üí OutputAudio ‚Üí ...
AnimController: –ú–û–õ–ß–ò–¢ (–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç —ç–∫—Ä–∞–Ω —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É)
–≠–∫—Ä–∞–Ω: DisplayImage (1—Å–µ–∫) - –†–ê–ë–û–¢–ê–ï–¢!
```

### 4. Screen Stays On (–≠–∫—Ä–∞–Ω –æ—Å—Ç–∞–µ—Ç—Å—è –≤–∫–ª—é—á–µ–Ω–Ω—ã–º)

**–ö—Ä–∏—Ç–∏—á–Ω–æ:** DisplayImage –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è **–î–ê–ñ–ï –í–û –í–†–ï–ú–Ø –ê–£–î–ò–û**!

```dart
// –í _tick() AnimationController:
if (_tickCounter % 30 == 0 && _currentImagePayload != null) {
  _client.sendCommand(CozmoCmd.displayImage, _currentImagePayload!);
}
```

–≠—Ç–æ –¥–µ—Ä–∂–∏—Ç —ç–∫—Ä–∞–Ω –≤–∫–ª—é—á–µ–Ω–Ω—ã–º, –ø–æ–∫–∞–∑—ã–≤–∞—è –≥–ª–∞–∑–∞/—É–ª—ã–±–∫—É –≤–æ –≤—Ä–µ–º—è —Ä–µ—á–∏.

### 5. Backpressure Only (–¢–æ–ª—å–∫–æ –ø—Ä–æ—Ç–∏–≤–æ–¥–∞–≤–ª–µ–Ω–∏–µ)

**–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ –∂–¥–∞—Ç—å:** –æ—á–µ—Ä–µ–¥—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞ (>100 –ø–∞–∫–µ—Ç–æ–≤)

```dart
while (_client.outboundQueueLength > 100) {
  await Future.delayed(const Duration(milliseconds: 1));
}
```

## üìä –î–∏–∞–≥—Ä–∞–º–º–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    AnimationController                      ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê           ‚îÇ
‚îÇ  ‚îÇ   IDLE STATE    ‚îÇ         ‚îÇ  AUDIO BUSY       ‚îÇ           ‚îÇ
‚îÇ  ‚îÇ                 ‚îÇ         ‚îÇ                  ‚îÇ           ‚îÇ
‚îÇ  ‚îÇ Every tick:     ‚îÇ         ‚îÇ Every tick:      ‚îÇ           ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ OutputSilence ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ ‚Ä¢ –ú–û–õ–ß–ò–¢!        ‚îÇ           ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ DisplayImage  ‚îÇ         ‚îÇ ‚Ä¢ DisplayImage   ‚îÇ           ‚îÇ
‚îÇ  ‚îÇ   (—Ä–∞–∑ –≤ —Å–µ–∫)   ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   (—Ä–∞–∑ –≤ —Å–µ–∫)    ‚îÇ           ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îÇ
‚îÇ         ‚ñ≤                            ‚ñ≤                       ‚îÇ
‚îÇ         ‚îÇ audio ends                 ‚îÇ audio starts         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                            ‚îÇ
          ‚îÇ setAudioBusy(false)        ‚îÇ setAudioBusy(true)
          ‚îÇ                            ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      Audio Module                            ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ  ‚îÇ           _streamPackets()                        ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ                                                    ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ  1. setAudioBusy(true)  ‚Üê –ó–ê–•–í–ê–¢                 ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ  2. Send packets FAST                           ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ  3. Wait queue empty                            ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ  4. setAudioBusy(false) ‚Üê –í–û–ó–í–†–ê–¢                ‚îÇ       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **–ê—É–¥–∏–æ –±–µ–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π** - –Ω–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ OutputSilence
‚úÖ **–≠–∫—Ä–∞–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç** - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–∏–¥–Ω–æ –≤–æ –≤—Ä–µ–º—è –∞—É–¥–∏–æ
‚úÖ **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å** - –Ω–µ—Ç –±—É—Ç—ã–ª–æ—á–Ω—ã—Ö –≥–æ—Ä–ª—ã—à–µ–∫
‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - —á–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

## üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏

- [pycozmo conn.py](https://github.com/zayfod/pycozmo/blob/master/pycozmo/conn.py) - SendThread implementation
- [pycozmo anim.py](https://github.com/zayfod/pycozmo/blob/master/pycozmo/anim.py) - Animation controller
- PyCozmo documentation: https://pycozmo.readthedocs.io/

## üöÄ Production Checklist

- [ ] AnimController –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç (30 FPS)
- [ ] Audio –≤—ã–∑—ã–≤–∞–µ—Ç `setAudioBusy(true)` –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
- [ ] Audio –≤—ã–∑—ã–≤–∞–µ—Ç `setAudioBusy(false)` –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
- [ ] Audio —à–ª–µ—Ç –ø–∞–∫–µ—Ç—ã –ë–ï–ó –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–µ—Ä–∂–∏–≤–∞–Ω–∏—è
- [ ] DisplayImage –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É (–¥–∞–∂–µ –≤–æ –≤—Ä–µ–º—è –∞—É–¥–∏–æ)
- [ ] Backpressure –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è (–æ—á–µ—Ä–µ–¥—å > 100)
