# –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–∞–∫–µ—Ç–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã Cozmo

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ä–µ–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-—Å—Ä–µ–¥—ã-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
2. [–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–µ–≤–æ–≥–æ —Å–ª–æ—è](#—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è-—Å–µ—Ç–µ–≤–æ–≥–æ-—Å–ª–æ—è)
3. [–°–æ–∑–¥–∞–Ω–∏–µ AnimationController](#—Å–æ–∑–¥–∞–Ω–∏–µ-animationcontroller)
4. [–ê—É–¥–∏–æ –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞](#–∞—É–¥–∏–æ-–ø–æ–¥—Å–∏—Å—Ç–µ–º–∞)
5. [–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π](#–æ–±—Ä–∞–±–æ—Ç–∫–∞-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
6. [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è-–∏-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ä–µ–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Cozmo:

```
lib/
‚îú‚îÄ‚îÄ cozmo/
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ connection.dart          # UDP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ protocol.dart            # –ü—Ä–æ—Ç–æ–∫–æ–ª —Ñ—Ä–µ–π–º–æ–≤
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ packets.dart            # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–∞–∫–µ—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ audio/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ audio_encoder.dart       # –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ audio_player.dart        # –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ulaw_encoder.dart      # u-law –∫–æ–¥–µ–∫
‚îÇ   ‚îú‚îÄ‚îÄ video/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ image_encoder.dart      # RLE –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ simple_image.dart       # –ü—Ä–æ—Å—Ç—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ image_cache.dart       # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ animation/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ animation_controller.dart # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ emotion_player.dart      # –≠–º–æ—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ trigger_system.dart     # –¢—Ä–∏–≥–≥–µ—Ä—ã –∞–Ω–∏–º–∞—Ü–∏–π
‚îÇ   ‚îî‚îÄ‚îÄ client.dart               # –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∏–µ–Ω—Ç
‚îî‚îÄ‚îÄ examples/
    ‚îú‚îÄ‚îÄ basic_audio.dart            # –ü—Ä–∏–º–µ—Ä –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
    ‚îú‚îÄ‚îÄ image_display.dart          # –ü—Ä–∏–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    ‚îî‚îÄ‚îÄ combined_scene.dart         # –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å—Ü–µ–Ω–∞
```

### 2. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```yaml
dependencies:
  flutter:
    sdk: flutter
  
  # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞—É–¥–∏–æ
  flutter_sound: ^9.2.13
  path_provider: ^2.1.1
  
  # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
  flutter_image: ^4.1.5
  
  # –î–ª—è —Å–µ—Ç–µ–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
  udp: ^5.0.3

dev_dependencies:
  flutter_test:
    sdk: flutter
  build_runner: ^2.4.6
  json_serializable: ^6.7.1
```

---

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–µ–≤–æ–≥–æ —Å–ª–æ—è

### 1. –ë–∞–∑–æ–≤—ã–π UDP –∫–ª–∏–µ–Ω—Ç

```dart
// lib/cozmo/core/connection.dart
import 'dart:io';
import 'dart:typed_data';

class CozmoConnection {
  late RawDatagramSocket _socket;
  InternetAddress? _cozmoAddress;
  bool _isConnected = false;
  
  final StreamController<Uint8List> _incomingController = 
      StreamController<Uint8List>.broadcast();
  
  Stream<Uint8List> get incoming => _incomingController.stream;
  
  Future<String?> connect({String? cozmoIP}) async {
    try {
      _socket = await RawDatagramSocket.bind(InternetAddress.anyIPv4, 0);
      _socket.broadcastEnabled = true;
      _socket.multicastHops = 1;
      
      _cozmoAddress = cozmoIP != null 
          ? InternetAddress(cozmoIP)
          : await _discoverCozmo();
      
      if (_cozmoAddress == null) {
        return 'Cozmo –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–µ—Ç–∏';
      }
      
      // –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –ø–∞–∫–µ—Ç–æ–≤
      _socket.listen(_onDataReceived);
      
      // –û—Ç–ø—Ä–∞–≤–∫–∞ RESET –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
      await _sendReset();
      
      _isConnected = true;
      return null;
    } catch (e) {
      return '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: $e';
    }
  }
  
  void _onDataReceived(RawDatagram? datagram) {
    if (datagram != null && datagram.address == _cozmoAddress) {
      _incomingController.add(datagram.data);
    }
  }
  
  Future<InternetAddress?> _discoverCozmo() async {
    // –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ Cozmo
    for (int i = 1; i <= 255; i++) {
      final testIP = InternetAddress('172.31.1.$i');
      // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...
      // –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã ping –∏–ª–∏ –¥—Ä—É–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    }
    return InternetAddress('172.31.1.1'); // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
  }
  
  Future<void> _sendReset() async {
    final resetFrame = _createResetFrame();
    _sendRaw(resetFrame);
  }
  
  List<int> _createResetFrame() {
    final data = <int>[];
    
    // FRAME_ID (7 –±–∞–π—Ç): "COZ\x03RE\x01"
    data.addAll([0x43, 0x4F, 0x5A, 0x03, 0x52, 0x45, 0x01]);
    
    // Frame Type: RESET (0x01)
    data.add(0x01);
    
    // Sequence numbers (–≤—Å–µ +1)
    data.addAll([0x01, 0x00]);  // first_seq
    data.addAll([0x01, 0x00]);  // seq
    data.addAll([0x01, 0x00]);  // ack
    
    return data;
  }
  
  void _sendRaw(List<int> data) {
    if (_isConnected && _cozmoAddress != null) {
      _socket.send(data, _cozmoAddress!, 5551);
    }
  }
  
  void disconnect() {
    if (_isConnected) {
      // –û—Ç–ø—Ä–∞–≤–∫–∞ FIN –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
      final finFrame = _createFinFrame();
      _sendRaw(finFrame);
      
      _socket.close();
      _isConnected = false;
    }
  }
  
  List<int> _createFinFrame() {
    final data = <int>[];
    
    // FRAME_ID
    data.addAll([0x43, 0x4F, 0x5A, 0x03, 0x52, 0x45, 0x01]);
    
    // Frame Type: FIN (0x03)
    data.add(0x03);
    
    // Sequence numbers
    data.addAll([0x01, 0x00]);  // first_seq
    data.addAll([0x01, 0x00]);  // seq
    data.addAll([0x01, 0x00]);  // ack
    
    return data;
  }
}
```

### 2. –ù–∞–¥—ë–∂–Ω—ã–π UDP —Å–ª–æ–π

```dart
// lib/cozmo/core/protocol.dart
import 'dart:async';
import 'dart:collection';
import 'dart:typed_data';

class ReliableProtocol {
  final CozmoConnection _connection;
  final Map<int, InFlightPacket> _inflightPackets = {};
  final Queue<PacketData> _outboundQueue = Queue();
  
  int _nextSequence = 0;
  int _lastRemoteAck = -1;
  Timer? _tickTimer;
  
  static const int _WINDOW_SIZE = 32;
  static const int _RTO_MS = 25;
  static const int _TICK_INTERVAL_MS = 5;
  
  ReliableProtocol(this._connection) {
    _connection.incoming.listen(_handleIncomingPacket);
    _startTickTimer();
  }
  
  void _startTickTimer() {
    _tickTimer = Timer.periodic(
      Duration(milliseconds: _TICK_INTERVAL_MS),
      _tick,
    );
  }
  
  void _tick(Timer timer) {
    // 1. –£–¥–∞–ª–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
    _removeAcknowledgedPackets();
    
    // 2. –†–µ—Ç—Ä–∞–Ω—Å–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ
    _retransmitLostPackets();
    
    // 3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã
    _sendNewPackets();
    
    // 4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å PING –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    _sendPingIfNeeded();
  }
  
  void _removeAcknowledgedPackets() {
    _inflightPackets.removeWhere((seq, packet) =>
        _getSeqDistance(seq, _lastRemoteAck) <= 0);
  }
  
  void _retransmitLostPackets() {
    final now = DateTime.now();
    
    for (final entry in _inflightPackets.entries) {
      final packet = entry.value;
      
      if (now.difference(packet.lastSentTime).inMilliseconds > _RTO_MS) {
        _sendRawFrame(packet.frameData);
        packet.lastSentTime = now;
        packet.retries++;
        
        print('üîÑ Retransmitting packet ${entry.key} (retry ${packet.retries})');
        return; // –û—Ç–ø—Ä–∞–≤–∏–ª–∏ –æ–¥–∏–Ω –ø–∞–∫–µ—Ç, –≤—ã—Ö–æ–¥–∏–º
      }
    }
  }
  
  void _sendNewPackets() {
    while (_inflightPackets.length < _WINDOW_SIZE && _outboundQueue.isNotEmpty) {
      final packetData = _outboundQueue.removeFirst();
      _sendReliableFrame(packetData);
    }
  }
  
  void _sendPingIfNeeded() {
    final now = DateTime.now();
    
    if (_lastPacketSentTime != null &&
        now.difference(_lastPacketSentTime!).inMilliseconds > 1000) {
      _sendPing();
    }
  }
  
  void _sendReliableFrame(PacketData packetData) {
    final frameData = _createEngineFrame(packetData);
    _sendRawFrame(frameData);
    
    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–ª—è —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏
    _inflightPackets[_nextSequence] = InFlightPacket(
      frameData: frameData,
      lastSentTime: DateTime.now(),
      retries: 0,
    );
    
    _nextSequence = (_nextSequence + 1) % 0x10000;
    _lastPacketSentTime = DateTime.now();
  }
  
  List<int> _createEngineFrame(PacketData packetData) {
    final writer = ByteWriter();
    
    // FRAME_ID
    writer.writeBytes([0x43, 0x4F, 0x5A, 0x03, 0x52, 0x45, 0x01]);
    
    // Frame Type: ENGINE (0x07)
    writer.writeUint8(0x07);
    
    // Sequence numbers (–∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å +1)
    writer.writeUint16((_nextSequence + 1) % 0x10000);
    writer.writeUint16((_nextSequence + 1) % 0x10000);
    writer.writeUint16((_lastRemoteAck + 1) % 0x10000);
    
    // Packet payload
    writer.writeBytes(packetData.toBytes());
    
    return writer.toBytes();
  }
  
  void _sendRawFrame(List<int> frameData) {
    _connection._sendRaw(frameData);
  }
  
  void _handleIncomingPacket(Uint8List data) {
    if (data.length < 14) return; // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ—Ä–µ–π–º–∞
    
    final frameType = data[7];
    
    if (frameType == 0x09) { // ROBOT frame
      _handleRobotFrame(data);
    } else if (frameType == 0x0b) { // PING frame
      _handlePingFrame(data);
    }
  }
  
  void _handleRobotFrame(Uint8List data) {
    if (data.length < 16) return;
    
    // –ò–∑–≤–ª–µ—á—å sequence numbers
    final ack = _extractSeq(data, 12);
    
    if (ack != _lastRemoteAck) {
      _lastRemoteAck = ack;
      print('üì® Received ACK: $ack');
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞–∫–µ—Ç—ã –¥–∞–Ω–Ω—ã—Ö
    final packetType = data[14];
    if (packetType == 0x05) { // EVENT packet
      _handleEventPacket(data);
    }
  }
  
  void _handlePingFrame(Uint8List data) {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ PING –æ—Ç–≤–µ—Ç–æ–≤
    final ack = _extractSeq(data, 12);
    if (ack != _lastRemoteAck) {
      _lastRemoteAck = ack;
      print('üèì PING ACK: $ack');
    }
  }
  
  int _extractSeq(Uint8List data, int offset) {
    return (data[offset + 1] << 8) | data[offset] - 1; // -1 –¥–ª—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
  }
  
  int _getSeqDistance(int seq1, int seq2) {
    int distance = seq1 - seq2;
    if (distance > 0x8000) distance -= 0x10000;
    if (distance < -0x8000) distance += 0x10000;
    return distance;
  }
  
  Future<void> sendCommand(int commandId, List<int> payload) async {
    final packetData = CommandPacket(
      type: 0x04, // COMMAND
      commandId: commandId,
      payload: payload,
    );
    
    _outboundQueue.add(packetData);
  }
  
  void dispose() {
    _tickTimer?.cancel();
    _connection.disconnect();
  }
}

class PacketData {
  final int type;
  final int commandId;
  final List<int> payload;
  
  PacketData({
    required this.type,
    required this.commandId,
    required this.payload,
  });
  
  List<int> toBytes() {
    final writer = ByteWriter();
    writer.writeUint8(type);
    writer.writeUint16(payload.length + 1); // +1 –¥–ª—è commandId
    writer.writeUint8(commandId);
    writer.writeBytes(payload);
    return writer.toBytes();
  }
}

class CommandPacket extends PacketData {
  CommandPacket({required int commandId, required List<int> payload})
      : super(type: 0x04, commandId: commandId, payload: payload);
}

class InFlightPacket {
  List<int> frameData;
  DateTime lastSentTime;
  int retries;
  
  InFlightPacket({
    required this.frameData,
    required this.lastSentTime,
    required this.retries,
  });
}
```

---

## –°–æ–∑–¥–∞–Ω–∏–µ AnimationController

### 1. –ë–∞–∑–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Audio Takeover –≤ pycozmo

**AnimationController –≤ pycozmo** (anim_controller.py:166-173):
```python
def _run(self):
    # Enable animation playback and AnimationState events
    pkt = protocol_encoder.EnableAnimationState()
    self.cli.conn.send(pkt)
    
    timer = util.FPSTimer(robot.FRAME_RATE)
    while not self.stop_flag:
        audio_pkt, image_pkt, pkts = self.queue.get()
        
        if self.animations_enabled:
            if audio_pkt:
                if not self.playing_audio:
                    self.playing_audio = True
            else:
                # –í–æ—Ç –∫–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç! –û—Ç–ø—Ä–∞–≤–∫–∞ silence –∫–æ–≥–¥–∞ –Ω–µ—Ç –∞—É–¥–∏–æ
                audio_pkt = protocol_encoder.OutputSilence()
                if self.playing_audio:
                    self.playing_audio = False
                    self.cli.conn.post_event(event.EvtAudioCompleted, self.cli)
            self.cli.conn.send(audio_pkt)
            
            # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –¥–∞–∂–µ –≤–æ –≤—Ä–µ–º—è –∞—É–¥–∏–æ!
            if not image_pkt and self.procedural_face_enabled and not self.playing_animation:
                image_pkt = self._get_face_image()
            
            if image_pkt:
                self.cli.conn.send(image_pkt)
                self.last_image_pkt = image_pkt
            else:
                # –ï—Å–ª–∏ –Ω–µ –æ–±–Ω–æ–≤–ª—è—Ç—å, —Ä–æ–±–æ—Ç –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
                self.cli.conn.send(self.last_image_pkt)
            
            if pkts:
                for pkt in pkts:
                    self.cli.conn.send(pkt)
            
            timer.sleep()
```

**Dart —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```dart
// lib/cozmo/animation/animation_controller.dart
import 'dart:async';
import 'dart:typed_data';

class CozmoAnimationController {
  final ReliableProtocol _protocol;
  Timer? _tickTimer;
  
  bool _isAudioBusy = false;
  int _tickCounter = 0;
  List<int>? _currentImagePayload;
  
  static const int _TICK_INTERVAL_MS = 33; // ~30 FPS
  static const int _IMAGE_UPDATE_INTERVAL = 30; // –ö–∞–∂–¥—ã–µ 30 —Ç–∏–∫–æ–≤ = ~1 —Å–µ–∫
  
  CozmoAnimationController(this._protocol) {
    _startTickTimer();
  }
  
  void _startTickTimer() {
    _tickTimer = Timer.periodic(
      Duration(milliseconds: _TICK_INTERVAL_MS),
      _tick,
    );
  }
  
  void _tick(Timer timer) {
    // 1. –ê–£–î–ò–û / –¢–ò–®–ò–ù–ê
    if (!_isAudioBusy) {
      _protocol.sendCommand(0x8f, []); // OutputSilence
    }
    
    // 2. –≠–ö–†–ê–ù (–î–ê–ñ–ï –í–û –í–†–ï–ú–Ø –ê–£–î–ò–û!)
    if (_tickCounter % _IMAGE_UPDATE_INTERVAL == 0 && _currentImagePayload != null) {
      _protocol.sendCommand(0x20, _currentImagePayload!); // DisplayImage
    }
    
    _tickCounter++;
  }
  
  // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
  void setCurrentImage(List<int> imagePayload) {
    _currentImagePayload = imagePayload;
  }
  
  // –ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –∞—É–¥–∏–æ-–º–æ–¥—É–ª—è
  void setAudioBusy(bool busy) {
    if (_isAudioBusy != busy) {
      _isAudioBusy = busy;
      print('üéµ Audio state changed: ${busy ? "BUSY" : "FREE"}');
    }
  }
  
  void dispose() {
    _tickTimer?.cancel();
  }
}
```

### 2. –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Å —ç–º–æ—Ü–∏—è–º–∏

```dart
// lib/cozmo/animation/emotion_player.dart
enum CozmoEmotion {
  happy,
  sad,
  surprised,
  thinking,
  frustrated,
  scared,
  sleepy,
  greeting,
  win,
  lose,
  chatty,
}

class CozmoEmotionPlayer {
  final ReliableProtocol _protocol;
  final CozmoAnimationController _animController;
  
  CozmoEmotionPlayer(this._protocol, this._animController);
  
  Future<void> playEmotion(CozmoEmotion emotion, {int loops = 1}) async {
    final triggerId = _getEmotionTriggerId(emotion);
    
    for (int i = 0; i < loops; i++) {
      await _playAnimationTrigger(triggerId);
      if (i < loops - 1) {
        await Future.delayed(Duration(milliseconds: 500));
      }
    }
  }
  
  Future<void> _playAnimationTrigger(int triggerId) async {
    // –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ PlayAnimationTrigger (0x26)
    final payload = <int>[];
    payload.addAll(_int32ToBytes(triggerId)); // trigger_id
    payload.add(0x00); // unknown1
    payload.addAll(_int32ToBytes(-1)); // unknown2
    payload.addAll(_int32ToBytes(-1)); // unknown3
    payload.add(0x00); // unknown4
    
    await _protocol.sendCommand(0x26, payload);
    
    // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç–∏–ø–∏—á–Ω–æ–π —ç–º–æ—Ü–∏–∏ ~1-2 —Å–µ–∫—É–Ω–¥—ã
    await Future.delayed(Duration(milliseconds: 1500));
  }
  
  int _getEmotionTriggerId(CozmoEmotion emotion) {
    // ID —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ pycozmo CozmoAnim triggers
    switch (emotion) {
      case CozmoEmotion.happy:
        return 0x62775834; // "happy" trigger hash
      case CozmoEmotion.sad:
        return 0x6d333d34; // "sad" trigger hash
      case CozmoEmotion.surprised:
        return 0x3fa6f867; // "surprised" trigger hash
      case CozmoEmotion.thinking:
        return 0x63f8a8c6; // "thinking" trigger hash
      case CozmoEmotion.frustrated:
        return 0x728d22f7; // "frustrated" trigger hash
      case CozmoEmotion.scared:
        return 0x4e6a7b3d; // "scared" trigger hash
      case CozmoEmotion.sleepy:
        return 0x55512d8e; // "sleepy" trigger hash
      case CozmoEmotion.greeting:
        return 0x6c4d4f21; // "greeting" trigger hash
      case CozmoEmotion.win:
        return 0x63f8a8c6; // "win" trigger hash (same as thinking)
      case CozmoEmotion.lose:
        return 0x4e6a7b3d; // "lose" trigger hash (same as scared)
      case CozmoEmotion.chatty:
        return 0x5aa65d3e; // "chatty" trigger hash
    }
  }
  
  List<int> _int32ToBytes(int value) {
    return [
      value & 0xFF,
      (value >> 8) & 0xFF,
      (value >> 16) & 0xFF,
      (value >> 24) & 0xFF,
    ];
  }
}
```

---

## –ê—É–¥–∏–æ –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞

### 1. u-law –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ

```dart
// lib/cozmo/audio/ulaw_encoder.dart
class ULawEncoder {
  static const int MULAW_MAX = 0x7FFF;
  static const int MULAW_BIAS = 132;
  
  static List<int> encodePCM16(List<int> pcmData) {
    final encoded = <int>[];
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—ã –±–∞–π—Ç –≤ 16-bit —Å—ç–º–ø–ª—ã
    for (int i = 0; i < pcmData.length; i += 2) {
      if (i + 1 < pcmData.length) {
        final sample = (pcmData[i + 1] << 8) | pcmData[i];
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å signed little-endian –≤ signed int
        final signedSample = sample > 32767 ? sample - 65536 : sample;
        encoded.add(_uLawEncode(signedSample));
      }
    }
    
    return encoded;
  }
  
  static int _uLawEncode(int sample) {
    int mask = 0x4000;
    int position = 14;
    int sign = 0;
    
    if (sample < 0) {
      sample = -sample;
      sign = 0x80;
    }
    
    sample += MULAW_BIAS;
    if (sample > MULAW_MAX) {
      sample = MULAW_MAX;
    }
    
    while ((sample & mask) != mask && position >= 7) {
      mask >>= 1;
      position--;
    }
    
    final lsb = (sample >> (position - 4)) & 0x0f;
    return -(~(sign | ((position - 7) << 4) | lsb));
  }
}
```

### 2. –ê—É–¥–∏–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—å —Å Audio Takeover

```dart
// lib/cozmo/audio/audio_player.dart
class CozmoAudioPlayer {
  final ReliableProtocol _protocol;
  final CozmoAnimationController _animController;
  
  bool _isPlaying = false;
  Timer? _playbackTimer;
  
  CozmoAudioPlayer(this._protocol, this._animController);
  
  Future<void> playWAVFile(String wavPath) async {
    if (_isPlaying) {
      throw StateError('Audio already playing');
    }
    
    try {
      _isPlaying = true;
      
      // 1. –ó–ê–•–í–ê–¢–´–í–ê–ï–ú –ö–û–ù–¢–†–û–õ–¨
      _animController.setAudioBusy(true);
      
      // 2. –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å WAV
      final file = File(wavPath);
      final bytes = await file.readAsBytes();
      final pcmData = _extractPCMFromWAV(bytes);
      final ulawData = ULawEncoder.encodePCM16(pcmData);
      
      // 3. –†–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –ø–∞–∫–µ—Ç—ã
      final packets = _splitIntoPackets(ulawData);
      
      // 4. –ë–´–°–¢–†–ê–Ø –û–¢–ü–†–ê–í–ö–ê
      await _sendPacketsFast(packets);
      
    } finally {
      // 5. –í–û–ó–í–†–ê–©–ê–ï–ú –ö–û–ù–¢–†–û–õ–¨
      _animController.setAudioBusy(false);
      _isPlaying = false;
    }
  }
  
  List<int> _extractPCMFromWAV(List<int> wavData) {
    // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è WAV 16-bit PCM
    if (wavData.length < 44) return [];
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ WAV —Ñ–æ—Ä–º–∞—Ç–∞
    final header = String.fromCharCodes(wavData.sublist(0, 4));
    if (header != 'RIFF') {
      throw FormatException('Not a WAV file');
    }
    
    // –ò–∑–≤–ª–µ—á—å PCM –¥–∞–Ω–Ω—ã–µ (–ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ 44 –±–∞–π—Ç–∞)
    return wavData.sublist(44);
  }
  
  List<List<int>> _splitIntoPackets(List<int> ulawData) {
    final packets = <List<int>>[];
    static const int PACKET_SIZE = 744; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—ç–º–ø–ª–æ–≤ –≤ –ø–∞–∫–µ—Ç–µ
    
    for (int i = 0; i < ulawData.length; i += PACKET_SIZE) {
      final end = math.min(i + PACKET_SIZE, ulawData.length);
      final chunk = ulawData.sublist(i, end);
      packets.add(chunk);
    }
    
    return packets;
  }
  
  Future<void> _sendPacketsFast(List<List<int>> packets) async {
    for (int i = 0; i < packets.length; i++) {
      // –¢–æ–ª—å–∫–æ backpressure —Ç–æ—Ä–º–æ–∑–∏—Ç –Ω–∞—Å
      while (_protocol.outboundQueueLength > 100) {
        await Future.delayed(Duration(milliseconds: 1));
      }
      
      // –°–æ–∑–¥–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å OutputAudio –ø–∞–∫–µ—Ç (0x8e)
      await _protocol.sendCommand(0x8e, packets[i]);
    }
    
    // –ñ–¥–µ–º –ø–æ–∫–∞ –æ—á–µ—Ä–µ–¥—å –æ–ø—É—Å—Ç–µ–µ—Ç
    while (_protocol.outboundQueueLength > 0) {
      await Future.delayed(Duration(milliseconds: 50));
    }
  }
  
  void stop() {
    _playbackTimer?.cancel();
    _isPlaying = false;
    _animController.setAudioBusy(false);
  }
}
```

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

### 1. –ü—Ä–æ—Å—Ç—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

```dart
// lib/cozmo/video/simple_image.dart
class CozmoSimpleImage {
  static const int WIDTH = 128;
  static const int HEIGHT = 32;
  
  final List<int> pixels = List.filled(WIDTH * HEIGHT, 0);
  
  CozmoSimpleImage();
  
  factory CozmoSimpleImage.createEyes() {
    final img = CozmoSimpleImage();
    
    // –õ–µ–≤—ã–π –≥–ª–∞–∑ (35-55, 8-16)
    img.drawRect(35, 8, 55, 16);
    
    // –ü—Ä–∞–≤—ã–π –≥–ª–∞–∑ (73-93, 8-16)
    img.drawRect(73, 8, 93, 16);
    
    // –£–ª—ã–±–∫–∞ (–ª–∏–Ω–∏—è –æ—Ç 40 –¥–æ 88 –Ω–∞ y=24)
    for (int x = 40; x <= 88; x++) {
      img.setPixel(x, 24, 255);
    }
    
    return img;
  }
  
  factory CozmoSimpleImage.createHappy() {
    final img = CozmoSimpleImage();
    
    // –ì–ª–∞–∑–∞-–ø–æ–ª—É–º–µ—Å—è—Ü—ã
    img.drawArc(35, 8, 20, 8, 0, math.pi);
    img.drawArc(73, 8, 20, 8, 0, math.pi);
    
    // –ë–æ–ª—å—à–∞—è —É–ª—ã–±–∫–∞
    img.drawArc(40, 12, 48, 20, 0.2 * math.pi, 0.8 * math.pi);
    
    return img;
  }
  
  factory CozmoSimpleImage.createSad() {
    final img = CozmoSimpleImage();
    
    // –û–ø—É—â–µ–Ω–Ω—ã–µ –≥–ª–∞–∑–∞
    img.drawLine(35, 12, 55, 12);
    img.drawLine(73, 12, 93, 12);
    
    // –û–ø—É—â–µ–Ω–Ω—ã–µ —É–≥–æ–ª–∫–∏ —Ä—Ç–∞
    img.drawLine(40, 24, 50, 28);
    img.drawLine(78, 28, 88, 24);
    
    return img;
  }
  
  void setPixel(int x, int y, int value) {
    if (x >= 0 && x < WIDTH && y >= 0 && y < HEIGHT) {
      pixels[y * WIDTH + x] = value;
    }
  }
  
  void drawRect(int x1, int y1, int x2, int y2) {
    for (int y = y1; y <= y2; y++) {
      for (int x = x1; x <= x2; x++) {
        setPixel(x, y, 255);
      }
    }
  }
  
  void drawLine(int x1, int y1, int x2, int y2) {
    final dx = (x2 - x1).abs();
    final dy = (y2 - y1).abs();
    final sx = x1 < x2 ? 1 : -1;
    final sy = y1 < y2 ? 1 : -1;
    int err = dx - dy;
    
    int x = x1;
    int y = y1;
    
    while (true) {
      setPixel(x, y, 255);
      
      if (x == x2 && y == y2) break;
      
      final e2 = 2 * err;
      if (e2 > -dy) {
        err -= dy;
        x += sx;
      }
      if (e2 < dx) {
        err += dx;
        y += sy;
      }
    }
  }
  
  void drawArc(int x, int y, int width, int height, double startAngle, double endAngle) {
    // –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –¥—É–≥–∏
    final centerX = x + width ~/ 2;
    final centerY = y + height ~/ 2;
    final radiusX = width ~/ 2;
    final radiusY = height ~/ 2;
    
    for (double angle = startAngle; angle <= endAngle; angle += 0.1) {
      final px = centerX + (radiusX * math.cos(angle)).round();
      final py = centerY + (radiusY * math.sin(angle)).round();
      setPixel(px, py, 255);
    }
  }
  
  List<int> encodeRLE() {
    final result = <int>[];
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ RLE –¥–ª—è Cozmo
    result.add(0x03); // Flags
    result.add(0x01); // ImgID
    result.add(0x00); // ChunkID
    
    // –ü—Ä–æ—Å—Ç–æ–π RLE –ø–æ —Å—Ç–æ–ª–±—Ü–∞–º
    for (int x = 0; x < WIDTH; x++) {
      int blankPixels = 0;
      int lastPixel = -1;
      int repeatCount = 0;
      
      for (int y = 0; y < HEIGHT; y++) {
        final pixel = pixels[y * WIDTH + x];
        
        if (pixel == 0) {
          if (lastPixel != 0) {
            if (repeatCount > 0) {
              _addRepeat(result, repeatCount);
              repeatCount = 0;
            }
          }
          blankPixels++;
          lastPixel = 0;
        } else {
          if (blankPixels > 0) {
            _addSkip(result, blankPixels);
            blankPixels = 0;
          }
          
          if (pixel == lastPixel && repeatCount < 15) {
            repeatCount++;
          } else {
            if (repeatCount > 0) {
              _addRepeat(result, repeatCount);
              repeatCount = 0;
            }
            _addPixel(result, pixel);
            lastPixel = pixel;
          }
        }
      }
      
      // –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü
      if (blankPixels > 0) {
        _addSkip(result, blankPixels);
      }
      if (repeatCount > 0) {
        _addRepeat(result, repeatCount);
      }
    }
    
    return result;
  }
  
  void _addSkip(List<int> result, int count) {
    while (count > 0) {
      final chunk = math.min(count - 1, 0x3F);
      result.add(chunk); // Skip (0x00-0x3F)
      count -= chunk + 1;
    }
  }
  
  void _addRepeat(List<int> result, int count) {
    while (count > 0) {
      final chunk = math.min(count - 1, 0x3F);
      result.add(0x40 | chunk); // Repeat (0x40-0x7F)
      count -= chunk + 1;
    }
  }
  
  void _addPixel(List<int> result, int pixel) {
    result.add(0x80); // Draw (0x80)
    result.add(pixel); // Pixel value
  }
}
```

### 2. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

```dart
// lib/cozmo/video/image_cache.dart
class CozmoImageCache {
  static final Map<String, List<int>> _cache = {};
  static bool _initialized = false;
  
  static Future<void> initialize() async {
    if (_initialized) return;
    
    // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    final commonImages = [
      'eyes', 'happy', 'sad', 'surprised', 
      'thinking', 'frustrated', 'scared'
    ];
    
    for (final name in commonImages) {
      await _preloadImage(name);
    }
    
    _initialized = true;
    print('üñºÔ∏è Image cache initialized with ${_cache.length} images');
  }
  
  static Future<List<int>> _preloadImage(String name) async {
    if (_cache.containsKey(name)) return _cache[name]!;
    
    late CozmoSimpleImage img;
    
    switch (name) {
      case 'eyes':
        img = CozmoSimpleImage.createEyes();
        break;
      case 'happy':
        img = CozmoSimpleImage.createHappy();
        break;
      case 'sad':
        img = CozmoSimpleImage.createSad();
        break;
      case 'surprised':
        img = CozmoSimpleImage.createSurprised();
        break;
      case 'thinking':
        img = CozmoSimpleImage.createThinking();
        break;
      case 'frustrated':
        img = CozmoSimpleImage.createFrustrated();
        break;
      case 'scared':
        img = CozmoSimpleImage.createScared();
        break;
      default:
        img = CozmoSimpleImage.createEyes();
    }
    
    final rleData = img.encodeRLE();
    _cache[name] = rleData;
    
    return rleData;
  }
  
  static List<int> getImage(String name) {
    if (!_initialized) {
      throw StateError('Image cache not initialized. Call initialize() first.');
    }
    
    return _cache[name] ?? _cache['eyes']!;
  }
  
  static void clearCache() {
    _cache.clear();
    _initialized = false;
    print('üóëÔ∏è Image cache cleared');
  }
}
```

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∏–µ–Ω—Ç

```dart
// lib/cozmo/client.dart
class CozmoClient {
  late CozmoConnection _connection;
  late ReliableProtocol _protocol;
  late CozmoAnimationController _animController;
  late CozmoAudioPlayer _audioPlayer;
  late CozmoEmotionPlayer _emotionPlayer;
  
  bool _isConnected = false;
  
  CozmoClient();
  
  Future<String?> connect({String? cozmoIP}) async {
    try {
      // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫—ç—à–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
      await CozmoImageCache.initialize();
      
      // 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
      _connection = CozmoConnection();
      final error = await _connection.connect(cozmoIP: cozmoIP);
      if (error != null) return error;
      
      // 3. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
      _protocol = ReliableProtocol(_connection);
      
      // 4. –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤
      _animController = CozmoAnimationController(_protocol);
      _audioPlayer = CozmoAudioPlayer(_protocol, _animController);
      _emotionPlayer = CozmoEmotionPlayer(_protocol, _animController);
      
      // 5. –û—Ç–ø—Ä–∞–≤–∫–∞ Enable –∫–æ–º–∞–Ω–¥—ã
      await _protocol.sendCommand(0x25, []); // Enable
      
      _isConnected = true;
      print('ü§ñ Cozmo connected successfully!');
      return null;
    } catch (e) {
      return 'Connection failed: $e';
    }
  }
  
  // API –º–µ—Ç–æ–¥—ã
  Future<void> playAudio(String wavPath) async {
    if (!_isConnected) throw StateError('Not connected to Cozmo');
    await _audioPlayer.playWAVFile(wavPath);
  }
  
  Future<void> playEmotion(CozmoEmotion emotion, {int loops = 1}) async {
    if (!_isConnected) throw StateError('Not connected to Cozmo');
    await _emotionPlayer.playEmotion(emotion, loops: loops);
  }
  
  Future<void> setVolume(int volume) async {
    if (!_isConnected) throw StateError('Not connected to Cozmo');
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –≤ Cozmo –¥–∏–∞–ø–∞–∑–æ–Ω (0-65535)
    final cozmoVolume = (volume / 100.0 * 65535).round();
    final payload = _int32ToBytes(cozmoVolume);
    await _protocol.sendCommand(0x64, payload); // SetRobotVolume
  }
  
  Future<void> setHeadAngle(double angle, {double speed = 10.0}) async {
    if (!_isConnected) throw StateError('Not connected to Cozmo');
    
    final payload = <int>[];
    payload.addAll(_float32ToBytes(angle)); // angle_rad
    payload.addAll(_float32ToBytes(speed)); // max_speed_rad_per_sec
    payload.addAll(_float32ToBytes(10.0)); // accel_rad_per_sec2
    payload.addAll(_float32ToBytes(0.0)); // duration_sec
    payload.add(0x00); // action_id
    
    await _protocol.sendCommand(0x37, payload); // SetHeadAngle
  }
  
  Future<void> displayImage(String imageName) async {
    if (!_isConnected) throw StateError('Not connected to Cozmo');
    
    final imageData = CozmoImageCache.getImage(imageName);
    _animController.setCurrentImage(imageData);
  }
  
  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
  List<int> _int32ToBytes(int value) {
    return [
      value & 0xFF,
      (value >> 8) & 0xFF,
      (value >> 16) & 0xFF,
      (value >> 24) & 0xFF,
    ];
  }
  
  List<int> _float32ToBytes(double value) {
    final byteData = ByteData(4)..setFloat32(0, value, Endian.little);
    return [
      byteData.getUint8(0),
      byteData.getUint8(1),
      byteData.getUint8(2),
      byteData.getUint8(3),
    ];
  }
  
  void disconnect() {
    if (_isConnected) {
      _animController.dispose();
      _protocol.dispose();
      _isConnected = false;
      print('ü§ñ Cozmo disconnected');
    }
  }
  
  bool get isConnected => _isConnected;
}
```

### 2. –ü—Ä–∏–º–µ—Ä –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π —Å—Ü–µ–Ω—ã

```dart
// lib/examples/combined_scene.dart
class CozmoCombinedScene {
  late CozmoClient _cozmo;
  
  Future<void> run() async {
    // 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    final error = await _cozmo.connect();
    if (error != null) {
      print('‚ùå Connection failed: $error');
      return;
    }
    
    try {
      // 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞
      await _cozmo.setVolume(80);
      await _cozmo.setHeadAngle(0.0); // –ì–æ–ª–æ–≤–∞ –ø—Ä—è–º–æ
      await _cozmo.displayImage('eyes');
      
      await Future.delayed(Duration(seconds: 1));
      
      // 3. –°—Ü–µ–Ω–∞—Ä–∏–π
      await _performWakeUpSequence();
      await Future.delayed(Duration(seconds: 1));
      
      await _performSpeakingSequence();
      await Future.delayed(Duration(seconds: 1));
      
      await _performEmotionalResponse();
      
    } finally {
      // 4. –û—Ç–∫–ª—é—á–µ–Ω–∏–µ
      _cozmo.disconnect();
    }
  }
  
  Future<void> _performWakeUpSequence() async {
    print('üé¨ Wake up sequence...');
    
    // –ü—Ä–æ—Å—ã–ø–∞–µ–º—Å—è
    await _cozmo.setHeadAngle(-0.2, speed: 5.0);
    await Future.delayed(Duration(milliseconds: 500));
    await _cozmo.setHeadAngle(0.0, speed: 5.0);
    await Future.delayed(Duration(milliseconds: 500));
    await _cozmo.setHeadAngle(0.3, speed: 5.0);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–ª—ã–±–∫—É
    await _cozmo.displayImage('happy');
    await _cozmo.playEmotion(CozmoEmotion.happy);
  }
  
  Future<void> _performSpeakingSequence() async {
    print('üó£Ô∏è Speaking sequence...');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥—É–º–∞—é—â–µ–µ –ª–∏—Ü–æ
    await _cozmo.displayImage('thinking');
    await _cozmo.playEmotion(CozmoEmotion.thinking);
    
    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º —Ä–µ—á—å
    await _cozmo.playAudio('assets/sounds/hello.wav');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –ª–∏—Ü–æ
    await _cozmo.displayImage('eyes');
  }
  
  Future<void> _performEmotionalResponse() async {
    print('üòä Emotional response...');
    
    // –°–ª—É—á–∞–π–Ω–∞—è —ç–º–æ—Ü–∏—è
    final emotions = [
      CozmoEmotion.happy,
      CozmoEmotion.surprised,
      CozmoEmotion.excited,
    ];
    
    final random = Random();
    final emotion = emotions[random.nextInt(emotions.length)];
    
    await _cozmo.playEmotion(emotion);
    await _cozmo.displayImage(emotion.toString().split('.').last);
  }
}
```

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```dart
// lib/examples/testing.dart
class CozmoTester {
  late CozmoClient _cozmo;
  
  Future<void> runAllTests() async {
    final error = await _cozmo.connect();
    if (error != null) {
      print('‚ùå Connection failed: $error');
      return;
    }
    
    try {
      await testBasicConnection();
      await testAudioPlayback();
      await testImageDisplay();
      await testAudioTakeover();
      await testEmotions();
      
      print('‚úÖ All tests completed successfully!');
    } catch (e) {
      print('‚ùå Test failed: $e');
    } finally {
      _cozmo.disconnect();
    }
  }
  
  Future<void> testBasicConnection() async {
    print('\nüß™ Testing basic connection...');
    
    // –¢–µ—Å—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–æ–ª–æ–≤–æ–π
    await _cozmo.setHeadAngle(-0.2);
    await Future.delayed(Duration(milliseconds: 500));
    await _cozmo.setHeadAngle(0.0);
    await Future.delayed(Duration(milliseconds: 500));
    await _cozmo.setHeadAngle(0.3);
    
    print('‚úÖ Head control test passed');
  }
  
  Future<void> testAudioPlayback() async {
    print('\nüß™ Testing audio playback...');
    
    final testAudio = 'assets/test_audio.wav';
    
    final stopwatch = Stopwatch()..start();
    await _cozmo.playAudio(testAudio);
    stopwatch.stop();
    
    print('‚úÖ Audio playback test passed (${stopwatch.elapsedMilliseconds}ms)');
  }
  
  Future<void> testImageDisplay() async {
    print('\nüß™ Testing image display...');
    
    final images = ['eyes', 'happy', 'sad', 'surprised'];
    
    for (final imageName in images) {
      await _cozmo.displayImage(imageName);
      await Future.delayed(Duration(milliseconds: 1000));
    }
    
    print('‚úÖ Image display test passed');
  }
  
  Future<void> testAudioTakeover() async {
    print('\nüß™ Testing audio takeover...');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    await _cozmo.displayImage('thinking');
    
    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∞—É–¥–∏–æ (–¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º)
    await _cozmo.playAudio('assets/test_audio.wav');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å—ë –µ—â—ë –≤–∏–¥–Ω–æ
    await Future.delayed(Duration(milliseconds: 500));
    
    print('‚úÖ Audio takeover test passed');
  }
  
  Future<void> testEmotions() async {
    print('\nüß™ Testing emotions...');
    
    final emotions = [
      CozmoEmotion.happy,
      CozmoEmotion.sad,
      CozmoEmotion.surprised,
      CozmoEmotion.thinking,
      CozmoEmotion.frustrated,
      CozmoEmotion.scared,
    ];
    
    for (final emotion in emotions) {
      await _cozmo.playEmotion(emotion);
      await Future.delayed(Duration(milliseconds: 1500));
    }
    
    print('‚úÖ Emotions test passed');
  }
}
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–≠—Ç–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è Cozmo —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—é –∞—É–¥–∏–æ –∏ –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ Audio Takeover Pattern.

### –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–ù–∞–¥—ë–∂–Ω—ã–π UDP —Å–ª–æ–π** —Å —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–µ–π –∏ sliding window
2. **Audio Takeover Pattern** –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –∞—É–¥–∏–æ –∏ –≤–∏–¥–µ–æ
3. **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ** –∞—É–¥–∏–æ (u-law) –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (RLE)
4. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤** –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
5. **–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. –ù–∞—á–Ω–∏—Ç–µ —Å –±–∞–∑–æ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –¥–æ–±–∞–≤–ª—è–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
2. –¢—â–∞—Ç–µ–ª—å–Ω–æ —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ Audio Takeover —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ –º–µ–Ω—è—é—Ç—Å—è
4. –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –ø–æ–¥ —Å–≤–æ—é –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∑–∞–¥–∞—á—É (–∞—É–¥–∏–æ, –≤–∏–¥–µ–æ –∏–ª–∏ —Å–º–µ—à–∞–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏)
5. –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –ø–æ—Ç–µ—Ä–∏ –ø–∞–∫–µ—Ç–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

–≠—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø—Ä–æ—á–Ω—É—é –æ—Å–Ω–æ–≤—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π —Å Cozmo, —Å–æ—á–µ—Ç–∞—é—â–∏—Ö –∞—É–¥–∏–æ –∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã.